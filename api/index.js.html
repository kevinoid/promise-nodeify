<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: index.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: index.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/** @module promise-nodeify
 * @copyright Copyright 2016 Kevin Locke &lt;kevin@kevinlocke.name>
 * @license MIT
 */
'use strict';

/** Function which will run with a clear stack as soon as possible.
 * @private
 */
var later =
  typeof process !== 'undefined' &amp;&amp;
    typeof process.nextTick === 'function' ? process.nextTick :
  typeof setImmediate === 'function' ? setImmediate :
  setTimeout;

/** Invokes callback and ensures any exceptions thrown are uncaught.
 * @private
 */
function doCallback(callback, reason, value) {
  // Note:  Could delay callback call until later, as When.js does, but this
  // loses the stack (particularly for bluebird long traces) and causes
  // unnecessary delay in the non-exception (common) case.
  try {
    // Match argument length to resolve/reject in case callback cares.
    // Note:  bluebird has argument length 1 if value === undefined due to
    // https://github.com/petkaantonov/bluebird/issues/170
    // If you are reading this and want similar behavior, I'll consider it.
    if (reason) {
      callback(reason);
    } else {
      callback(null, value);
    }
  } catch (err) {
    later(function() { throw err; });
  }
}

/** Calls a node-style callback when a Promise is resolved or rejected.
 *
 * This function provides the behavior of
 * {@link https://github.com/then/nodeify then &lt;code>nodeify&lt;/code>},
 * {@link
 * https://github.com/cujojs/when/blob/master/docs/api.md#nodebindcallback
 * when.js &lt;code>node.bindCallback&lt;/code>},
 * or {@link http://bluebirdjs.com/docs/api/ascallback.html bluebird
 * &lt;code>Promise.prototype.nodeify&lt;/code> (now
 * &lt;code>Promise.prototype.asCallback&lt;/code>)} (without options).
 *
 * @ template ValueType
 * @param {!Promise&lt;ValueType>} promise Promise to monitor.
 * @param {?function(*, ValueType=)=} callback Node-style callback to be
 * called when &lt;code>promise&lt;/code> is resolved or rejected.  If
 * &lt;code>promise&lt;/code> is rejected with a falsey value the first argument
 * will be an instance of &lt;code>Error&lt;/code> with a &lt;code>.cause&lt;/code>
 * property with the rejected value.
 * @return {Promise&lt;ValueType>|undefined} &lt;code>undefined&lt;/code> if
 * &lt;code>callback&lt;/code> is a function, otherwise a &lt;code>Promise&lt;/code>
 * which behaves like &lt;code>promise&lt;/code> (currently is &lt;code>promise&lt;/code>,
 * but is not guaranteed to remain so).
 * @alias module:promise-nodeify
 */
function promiseNodeify(promise, callback) {
  if (typeof callback !== 'function') {
    return promise;
  }

  function onRejected(reason) {
    // callback is unlikely to recognize or expect a falsey error.
    // (we also rely on truthyness for arguments.length in doCallback)
    // Convert it to something truthy
    var truthyReason = reason;
    if (!truthyReason) {
      // Note:  unthenify converts falsey rejections to TypeError:
      // https://github.com/blakeembrey/unthenify/blob/v1.0.0/src/index.ts#L32
      // We use bluebird convention for Error, message, and .cause property
      truthyReason = new Error(reason + '');
      truthyReason.cause = reason;
    }

    doCallback(callback, truthyReason);
  }

  function onResolved(value) {
    doCallback(callback, null, value);
  }

  promise.then(onResolved, onRejected);
  return undefined;
}

/** A version of {@link promiseNodeify} which delegates to the
 * &lt;code>.nodeify&lt;/code> method on &lt;code>promise&lt;/code>, if present.
 *
 * This may be more performant than {@see promiseNodeify} and have additional
 * implementation-specific features, but the behavior may differ from
 * &lt;code>promiseNodeify&lt;/code> and between Promise implementations.
 *
 * Note that this function only passes the callback argument to
 * &lt;code>.nodeify&lt;/code>, since additional arguments are interpreted
 * differently by different libraries (e.g. bluebird treats the next argument
 * as an options object while then treats it as &lt;code>this&lt;/code> for the
 * callback).
 *
 * @ template ValueType
 * @param {!Promise&lt;ValueType>} promise Promise to monitor.
 * @param {?function(*, ValueType=)=} callback Node-style callback.
 * @return {Promise&lt;ValueType>|undefined} Value returned by
 * &lt;code>.nodeify&lt;/code>.  Known implementations return the
 * &lt;code>promise&lt;/code> argument when callback is falsey and either
 * &lt;code>promise&lt;/code> or &lt;code>undefined&lt;/code> otherwise.
 */
promiseNodeify.delegated = function nodeifyDelegated(promise, callback) {
  if (typeof promise.nodeify === 'function') {
    return promise.nodeify(callback);
  }

  return promiseNodeify(promise, callback);
};

/** Polyfill for &lt;code>Promise.prototype.nodeify&lt;/code> which behaves like
 * {@link promiseNodeify}.
 *
 * @ template ValueType
 * @this {!Promise&lt;ValueType>}
 * @param {?function(*, ValueType=)=} callback Node-style callback.
 * @return {Promise&lt;ValueType>|undefined} &lt;code>undefined&lt;/code> if
 * &lt;code>callback&lt;/code> is a function, otherwise a &lt;code>Promise&lt;/code>
 * which behaves like &lt;code>promise&lt;/code> (currently is &lt;code>promise&lt;/code>,
 * but is not guaranteed to remain so).
 */
promiseNodeify.nodeifyThis = function nodeifyThis(callback) {
  return promiseNodeify(this, callback);
};

// Note: This file is used directly for Node and wrapped in UMD for browser
if (typeof exports === 'object') {
  module.exports = promiseNodeify;
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-promise-nodeify.html">promise-nodeify</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> on Fri Apr 01 2016 23:02:05 GMT-0700 (PDT)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
